<%@ page language="java" pageEncoding="UTF-8" isELIgnored="false" %>


<head>
    <%@ include file="/link.jsp" %>
    <style>
        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï†ÅÏö© */
        .selected-page {
            background-image: url("/resources/img/entertainment/cookie-bite.png") !important;
            background-size: contain; /* Ïù¥ÎØ∏ÏßÄÎ•º Î≤ÑÌäºÏóê ÍΩâ Ï±ÑÏö∞ÎèÑÎ°ù ÏÑ§Ï†ï */
            background-repeat: no-repeat;
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #784132;
        }

        /* ÌéòÏù¥ÏßÄ Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï†ÅÏö© */
        .page-buttons {
            display: flex;
            justify-content: center; /* ÏàòÌèâ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
            gap: 5px; /* Î≤ÑÌäº ÏÇ¨Ïù¥Ïùò Í∞ÑÍ≤© */

        }

        .page-button {
            background-image: url("/resources/img/entertainment/cookie.png");
            background-size: contain; /* Ïù¥ÎØ∏ÏßÄÎ•º Î≤ÑÌäºÏóê ÍΩâ Ï±ÑÏö∞ÎèÑÎ°ù ÏÑ§Ï†ï */
            background-repeat: no-repeat;
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #784132;
        }

        .page-button:hover {
            color: #F9F5F2; /* Ìò∏Î≤ÑÏãú Í∏ÄÏûê ÏÉâÏÉÅ Î≥ÄÍ≤Ω */
        }

        .search-results {
            list-style: none;
            padding-top: 24px;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .search-item {
            background-color: #F9F5F2;
            border-radius: 12px;
            padding: 15px;
            flex-basis: calc(33.33% - 20px); /* Í∞ÄÎ°ú ÎÑàÎπÑÎ•º Ï°∞Ï†à */
            box-sizing: border-box;
            transition: all .3s;
        }

        .search-item:hover {
            box-shadow: 0 2px 16px 0 rgba(92, 73, 44, 0.25);
        }

        .search-item > a {
            color: #5C492C;
        }

        .thumbnail img {
            display: block;
            margin: 0 auto;
            height: 180px;
            border-radius: 6px;
        }

        .product-name {
            font-family: Pretendard, sans-serif;
            font-size: 16px;
            font-weight: bold;
            line-height: 28px;
            margin-top: 10px;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px; /* ÏÉÅÎã® Ïó¨Î∞± ÏÑ§Ï†ï */
        }

        .pagination a {
            margin: 0 5px; /* Ï¢åÏö∞ Ïó¨Î∞± ÏÑ§Ï†ï */
            text-decoration: none;
        }

        .pagination span {
            margin: 0 5px;
            font-weight: bold;
        }
    </style>
    <title>Ï†ÑÍ≥ºÏûê</title>

</head>

<body>
<%@include file="/header.jsp" %>
<%@include file="/filterModal.jsp"%>
<div class="sub-container">
    <div class="v-left">
        <h3 class="h-pre36">
            üîç<br>
            Í∂ÅÍ∏àÌïú Í≥ºÏûêÍ∞Ä ÏûàÏúºÏã†Í∞ÄÏöî?
        </h3>
        <form id="snackWikiSearchForm" action="snackWikiSearch" method="get" onsubmit="return validateFormAndAddAllergyData()">
            <div class="cookie-search main-search">
                <div class="select-wrap">
                    <label class="label-bold" for="cookie-select">Category</label>
                    <select class="p-regular" id="cookie-select" name="category">
                        <option value="">Í≤ÄÏÉâ Ìï≠Î™©</option>
                        <option value="all" selected>Ï†ÑÏ≤¥</option>
                        <option value="name">Í≥ºÏûê Ïù¥Î¶Ñ</option>
                        <option value="ingredient">ÏõêÏû¨Î£å</option>
                    </select>
                </div>
                <span class="div-line"></span>
                <div class="search-wrap">
                    <label class="label-bold" for="keyword">Search</label>
                    <input class="p-regular" type="text" name="keyword" id="keyword"
                           placeholder="Í≤ÄÏÉâÌïòÍ≥† Ïã∂ÏùÄ Í≥ºÏûê Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.">
                </div>
                <input type="hidden" name="sortName" value="sortHighCalorie">
                <button class="search-btn" type="submit"><img src="/resources/img/icon/search.svg" alt="ÎèãÎ≥¥Í∏∞ ÏïÑÏù¥ÏΩò">
                </button>
            </div>
        </form>

        <%@include file="/filter.jsp"%>

        <span id="checkedAllergies">
        </span>
    </div>
    <div id="search-results-paginated">
        <p class="p-regular">"${keyword}"Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥º ${totalResults}Í±¥</p>
        <div id="sort-form" class="p-regular">
            <button id="sortHighCalorie" class="sort-btn">ÏπºÎ°úÎ¶¨ ‚ñ≤</button>
            <button id="sortLowCalorie" class="sort-btn">ÏπºÎ°úÎ¶¨ ‚ñº</button>
            <button id="sortHighSugar" class="sort-btn">Îãπ ‚ñ≤</button>
            <button id="sortLowSugar" class="sort-btn">Îãπ ‚ñº</button>
            <button id="sortHighProtein" class="sort-btn">Îã®Î∞±Ïßà ‚ñ≤</button>
            <button id="sortLowProtein" class="sort-btn">Îã®Î∞±Ïßà ‚ñº</button>
            <button id="sortHighFat" class="sort-btn">ÏßÄÎ∞© ‚ñ≤</button>
            <button id="sortLowFat" class="sort-btn">ÏßÄÎ∞© ‚ñº</button>
            <button id="sortHighScore" class="sort-btn">ÌèâÏ†ê ‚ñ≤</button>
            <button id="sortLowScore" class="sort-btn">ÌèâÏ†ê ‚ñº</button>
        </div>

        <div id="search-results" class="search-results">
            <%--Í≤ÄÏÉâ Í≤∞Í≥º Ï¥ù ${fn:length(searchResult)} Í±¥--%>
            <%--<div class="search-results">--%>
            <c:forEach items="${searchResults}" var="searchDTO" varStatus="status">
                <!-- Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Ï∂úÎ†• -->
                <div class="search-item">
                        <%--<a href="/snack/snackInfo?snack_id=${search.snack_id}">--%>
                    <a href="javascript:void(0);" class="goToDetail" data-snack-id="${searchDTO.snack_id}">
                        <div class="thumbnail search-thumbnail"
                             style="background-image: url(${searchDTO.snack_img})"></div>
                        <div class="product-name">${searchDTO.snack_name}</div>
                        <c:choose>
                            <c:when test="${searchDTO.avg_score >= 1 && searchDTO.avg_score < 1.5}">
                                <c:set var="scoreImg" value="<img src='/resources/img/score/score01.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 1.5 && searchDTO.avg_score < 2}">
                                <c:set var="scoreImg"
                                       value="<img src='/resources/img/score/score_01_half.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 2 && searchDTO.avg_score < 2.5}">
                                <c:set var="scoreImg" value="<img src='/resources/img/score/score02.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 2.5 && searchDTO.avg_score < 3}">
                                <c:set var="scoreImg"
                                       value="<img src='/resources/img/score/score_02_half.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 3 && searchDTO.avg_score < 3.5}">
                                <c:set var="scoreImg" value="<img src='/resources/img/score/score03.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 3.5 && searchDTO.avg_score < 4}">
                                <c:set var="scoreImg"
                                       value="<img src='/resources/img/score/score_03_half.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 4 && searchDTO.avg_score < 4.5}">
                                <c:set var="scoreImg" value="<img src='/resources/img/score/score04.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score >= 4.5 && searchDTO.avg_score < 5}">
                                <c:set var="scoreImg"
                                       value="<img src='/resources/img/score/score_04_half.png' height='18'>"/>
                            </c:when>
                            <c:when test="${searchDTO.avg_score == 5}">
                                <c:set var="scoreImg" value="<img src='/resources/img/score/score05.png' height='18'>"/>
                            </c:when>
                            <c:otherwise><c:set var="scoreImg" value=""/></c:otherwise>
                        </c:choose>
                        <div>${scoreImg}</div>
                    </a>
                </div>
            </c:forEach>
        </div>
    </div>

    <div class="pagination page-buttons" id="pagination">
        <a href="#" data-page="1">Ï≤´ ÌéòÏù¥ÏßÄ</a>

        <c:if test="${currentPage > 1}">
            <a href="#" data-page="${currentPage - 1}">&laquo;Ïù¥Ï†Ñ</a>
        </c:if>

        <c:forEach var="pageNum" begin="${startPage}" end="${endPage}">
            <c:choose>
                <c:when test="${pageNum == currentPage}">
                    <a class="page-button selected-page" href="#">${pageNum}</a>
                </c:when>
                <c:otherwise>
                    <a class="page-button" href="#" data-page="${pageNum}">${pageNum}</a>
                </c:otherwise>
            </c:choose>
        </c:forEach>

        <c:if test="${endPage < totalPages}">
            <a href="#" data-page="${currentPage + 1}">Îã§Ïùå&raquo;</a>
        </c:if>

        <a href="#" data-page="${totalPages}">ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ</a>
    </div>
</div>

<script>
    $(document).ready(function () {
        function attachSortClickEvent() {
            $('#sort-form .sort-btn').click(function () {
                let sortName = $(this).attr("id");
                let urlParams = new URL(location.href);
                let keyword = urlParams.searchParams.get('keyword');
                let category = urlParams.searchParams.get('category');
                let selectedAllergies = urlParams.searchParams.get('selectedAllergies');
                // ÌéòÏù¥ÏßÄÎ•º 1Î°ú ÏÑ§Ï†ïÌïòÏó¨ Ï†ïÎ†¨ ÌõÑ Ï≤´ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                let currentPage = 1;
                urlParams.searchParams.set('sortName', sortName);
                window.location.href = "snackWikiSearch?category=" + category + "&keyword=" + keyword + "&sortName=" + sortName + "&selectedAllergies=" + selectedAllergies + "&page=" + currentPage;
            });
        }

        attachSortClickEvent(); // Ï¥àÍ∏∞ Ï†ïÎ†¨ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Îì±Î°ù


        // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        $("#snackWikiSearchForm").on("submit", function (event) {
            event.preventDefault(); // Í∏∞Î≥∏ Ìèº Ï†úÏ∂ú ÎèôÏûëÏùÑ ÎßâÏùå
            validateFormAndAddAllergyData();
        });



        $("#sort-form").on("click", ".sort-btn", function (event) {
            event.preventDefault();
            let sortName = $(this).attr("id");
            let urlParams = new URL(location.href).searchParams;
            urlParams.set('sortName', sortName);
            let keyword = urlParams.get('keyword');
            let category = urlParams.get('category');
            submitSortRequest(sortName, keyword, category);
        });
        // ÌéòÏù¥ÏßÄ Î°úÎî© Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú AJAXÎ°ú ÌéòÏù¥ÏßÄ Î°úÎìú
        $(".pagination").on("click", "a", function (event) {
            event.preventDefault();
            let page = $(this).data("page");
            if (!page) {
                return;
            }
            let urlParams = new URL(location.href)
            let keyword = urlParams.searchParams.get('keyword');
            let category = urlParams.searchParams.get('category');
            let sortName = urlParams.searchParams.get('sortName');
            let selectedAllergies = urlParams.searchParams.get('selectedAllergies');
            window.location.href = "snackWikiSearch?category=" + category + "&keyword=" + keyword + "&sortName=" + sortName + "&selectedAllergies=" + selectedAllergies + "&page=" + page;
        });

        // ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎäî ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        $('#search-results-paginated').on('click', '.goToDetail', function () {
            let snackId = $(this).data('snack-id');
            let urlParams = new URL(location.href);
            let keyword = urlParams.searchParams.get('keyword');
            let category = urlParams.searchParams.get('category');
            let currentPage = urlParams.searchParams.get('page');
            let sortName = urlParams.searchParams.get('sortName');
            let selectedAllergies = urlParams.searchParams.get('selectedAllergies');
            if (currentPage == null) {
                currentPage = 1;
            }
            window.location.href = "/snack/snackWikiInfo?category=" + category + "&keyword=" + keyword + "&sortName=" + sortName + "&selectedAllergies=" + selectedAllergies + "&snack_id=" + snackId + "&page=" + currentPage;
        });
        // Ï†ïÎ†¨ ÌõÑÏóê Ïù¥Î≤§Ìä∏ Îã§Ïãú Îì±Î°ù
        $(document).ajaxComplete(function () {
            attachSortClickEvent();
        });

        $("#checkingAllergies").click(function () {
            modalShow();
        });

        $("#modal-close").click(function () {
            // Î™®Îã¨ ÎÇ¥Ïùò Î™®Îì† Ï≤¥ÌÅ¨ Î∞ïÏä§Î•º ÏÑ†ÌÉùÌïòÍ≥† Ìï¥Ï†úÌï©ÎãàÎã§.
            $(".allergy-check-btn input[type='checkbox']").prop("checked", false);

            // ÏÑ†ÌÉùÌïú ÏïåÎ†àÎ•¥Í∏∞ Ï†ïÎ≥¥Î•º Ï∂úÎ†•Ìï† div ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
            let checkedAllergiesDiv = $("#checkedAllergies");

            // Í∏∞Ï°¥ Ï†ïÎ≥¥Î•º ÏßÄÏö∞Í∏∞ ÏúÑÌï¥ div ÎÇ¥Ïö©ÏùÑ ÎπÑÏõÅÎãàÎã§.
            checkedAllergiesDiv.empty();
            modalHide();
        });

        // ÏïåÎ†àÎ•¥Í∏∞ Ï†ïÎ≥¥ Ï∂úÎ†• ÌõÑ, span ÌÅ¥Î¶≠ Ïãú ÎèôÏûë
        $("#checkedAllergies").on("click", ".checked-allergy", function () {
            // ÌÅ¥Î¶≠Ìïú ÏöîÏÜåÍ∞Ä Ïù¥ÎØ∏ÏßÄÏù∏ Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
            if ($(event.target).is("img")) {
                // ÌÅ¥Î¶≠Ìïú span ÏöîÏÜåÎ•º Ï†úÍ±∞Ìï©ÎãàÎã§.
                $(this).remove();

                // Ìï¥Îãπ span ÏöîÏÜåÏóê Ïó∞Í≤∞Îêú Ï≤¥ÌÅ¨Î∞ïÏä§Ïùò ID Í∞ÄÏ†∏Ïò§Í∏∞
                let checkboxId = $(this).attr("data-checkbox-id");

                // Ìï¥Îãπ IDÎ•º Í∞ÄÏßÑ Ï≤¥ÌÅ¨Î∞ïÏä§Ïùò Ï≤¥ÌÅ¨Î•º Ìï¥Ï†úÌï©ÎãàÎã§.
                $("#" + checkboxId).prop("checked", false);

                // Ï≤¥ÌÅ¨Î∞ïÏä§Ïùò Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏Î•º Ìä∏Î¶¨Í±∞ÌïòÏó¨ Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏùåÏùÑ Í∞êÏßÄÌï©ÎãàÎã§.
                $("#" + checkboxId).trigger("change");
            }
        });


        $("#checkedAllergiesData").click(function () {
            // ÏÑ†ÌÉùÌïú ÏïåÎ†àÎ•¥Í∏∞ Ï†ïÎ≥¥Î•º Ï∂úÎ†•Ìï† div ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
            let checkedAllergiesSpan = $("#checkedAllergies");

            // Í∏∞Ï°¥ Ï†ïÎ≥¥Î•º ÏßÄÏö∞Í∏∞ ÏúÑÌï¥ div ÎÇ¥Ïö©ÏùÑ ÎπÑÏõÅÎãàÎã§.
            checkedAllergiesSpan.empty();

            // Ï≤¥ÌÅ¨Îêú Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Í∞íÏùÑ ÏàòÏßëÌïòÍ±∞ÎÇò Ï≤òÎ¶¨Ìï† Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞ÏóêÏÑú Íµ¨ÏÑ±
            let selectedAllergies = [];

            // ÏòàÏãú: ÏÑ†ÌÉùÎêú Ï≤¥ÌÅ¨Î∞ïÏä§ Í∞íÏùÑ ÏàòÏßë
            $('input[name="selectedAllergies"]:checked').each(function () {
                let allergy = $(this).val();
                selectedAllergies.push(allergy);

                // ÏÑ†ÌÉùÌïú ÏïåÎ†àÎ•¥Í∏∞ Ï†ïÎ≥¥Î•º Í∞úÎ≥Ñ spanÏúºÎ°ú ÏÉùÏÑ±ÌïòÍ≥† Ï∂úÎ†•
                let labelForAllergy = $('label[for="' + this.id + '"]').html(); // Ï≤¥ÌÅ¨Î∞ïÏä§Ïóê Ïó∞Í≤∞Îêú ÎùºÎ≤® ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                let checkboxId = this.id; // Ï≤¥ÌÅ¨Î∞ïÏä§Ïùò ID Í∞ÄÏ†∏Ïò§Í∏∞
                let allergySpan = $("<span>").html(labelForAllergy).addClass('checked-allergy').attr('data-checkbox-id', checkboxId); // ÎùºÎ≤® ÎÇ¥Ïö©ÏùÑ spanÏóê Ï∂îÍ∞Ä

                // Ïù¥ÎØ∏ÏßÄ ÏöîÏÜå ÏÉùÏÑ± Î∞è Ï∂îÍ∞Ä
                let img = $("<img>").attr('src', '/resources/img/curation/delete_btn.svg').addClass('del-allergy-btn');
                allergySpan.append(img);

                checkedAllergiesSpan.append(allergySpan);
            });

// Î™®Îã¨ÏùÑ Ïà®ÍπÅÎãàÎã§.
            modalHide();
        });

        function submitSortRequest(sortName, keyword, category) {
            console.log(keyword, category);
            $.ajax({
                url: "snackWikiSearch",
                type: "GET",
                data: {
                    sortName: sortName,
                    keyword: keyword,
                    category: category,
                },
                success: function (data) {
                    // Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî ÏΩîÎìú ÏûëÏÑ±
                    console.log(data)
                    let $data = $(data);

                    // ÌéòÏù¥ÏßÄÎÇ¥Ïùò ÌäπÏ†ï Î∂ÄÎ∂ÑÏùÑ Ï∞æÏïÑ ÏóÖÎç∞Ïù¥Ìä∏
                    $("#search-results-paginated").html($data.find("#search-results-paginated").html());
                    $("#pagination").html($data.find("#pagination").html());

                },
                error: function () {
                    alert("Ï†ïÎ†¨ Ïã§Ìå®");
                }
            });
        }

        function validateFormAndAddAllergyData() {

            let category = document.getElementById("cookie-select").value;
            let keyword = document.getElementById("keyword").value; // Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•ÎûÄ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            if (category === "") {
                alert("Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í≥®ÎùºÏ£ºÏÑ∏Ïöî");
                return false;
            }


            // Ï≤¥ÌÅ¨Îêú Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§ Í∞íÏùÑ ÏàòÏßëÌïòÍ±∞ÎÇò Ï≤òÎ¶¨Ìï† Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞ÏóêÏÑú Íµ¨ÏÑ±
            let selectedAllergies = [];

            // ÏòàÏãú: ÏÑ†ÌÉùÎêú Ï≤¥ÌÅ¨Î∞ïÏä§ Í∞íÏùÑ ÏàòÏßë
            $('input[name="selectedAllergies"]:checked').each(function () {
                selectedAllergies.push($(this).val());
            });

            if (keyword.trim() === "") { // Í≤ÄÏÉâÏñ¥Í∞Ä Í≥µÎ∞± Î¨∏ÏûêÎ°úÎßå Ïù¥Î£®Ïñ¥Ï†∏ ÏûàÏúºÎ©¥ Í≤ÄÏÉâ ÎßâÍ∏∞
                alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }

            // Ìèº Îç∞Ïù¥ÌÑ∞Î°ú ÏÑ†ÌÉùÎêú ÏïåÎ†àÎ•¥Í∏∞Î•º Ï∂îÍ∞Ä
            let selectedAllergiesField = document.createElement('input');
            selectedAllergiesField.setAttribute('type', 'hidden');
            selectedAllergiesField.setAttribute('name', 'selectedAllergies'); // Ïù¥Î¶Ñ ÏÑ§Ï†ï
            selectedAllergiesField.setAttribute('value', selectedAllergies.join(','));

            // ÌèºÏóê Ìèº ÌïÑÎìú Ï∂îÍ∞Ä
            let form = document.getElementById('snackWikiSearchForm');
            form.appendChild(selectedAllergiesField);

            // Ìèº Ï†úÏ∂ú
            form.submit();
            return true;
        }
    });


</script>
<%@include file="/footer.jsp" %>
</body>

